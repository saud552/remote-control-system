name: Deploy to Render

on:
  push:
    branches: [main, ready-for-merge-about-blank-fix]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy Command Server
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/ready-for-merge-about-blank-fix'
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "๐ ุจุฏุก ูุดุฑ ุงูุฎุงุฏู ุนูู Render..."
          echo "๐ ุงููุฑุน: ${{ github.ref }}"
          echo "๐ Commit: ${{ github.sha }}"
          
          if [ -n "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "๐ค ุฅุฑุณุงู ุทูุจ ุงููุดุฑ..."
            response=$(curl -s -w "%{http_code}" -o /tmp/deploy_response "$RENDER_DEPLOY_HOOK_URL")
            
            if [ "$response" = "200" ]; then
              echo "โ ุชู ุจุฏุก ุงููุดุฑ ุจูุฌุงุญ!"
              echo "๐ ุงุณุชุฌุงุจุฉ ุงูุฎุงุฏู:"
              cat /tmp/deploy_response
            else
              echo "โ ูุดู ูู ุจุฏุก ุงููุดุฑ - HTTP $response"
              cat /tmp/deploy_response
              exit 1
            fi
          else
            echo "โ๏ธ RENDER_DEPLOY_HOOK_URL ุบูุฑ ููุนุฑููู ูู ุงูุฃุณุฑุงุฑ"
            echo "๐ ูุฑุฌู ุฅุถุงูุฉ ุฑุงุจุท ุงููุดุฑ ูู ุฅุนุฏุงุฏุงุช ุงููุณุชูุฏุน"
            exit 1
          fi
          
      - name: Wait for deployment
        run: |
          echo "โณ ุงูุชุธุงุฑ ุงูุชูุงู ุงููุดุฑ..."
          sleep 30
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุนูููุฉ ุงููุดุฑ"
          
      - name: Verify deployment
        run: |
          echo "๐ ุงูุชุญูู ูู ุญุงูุฉ ุงูุฎุงุฏู..."
          
          # ูุญุงููุฉ ุงูุงุชุตุงู ุจุงูุฎุงุฏู
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "๐ ูุญุงููุฉ $attempt ูู $max_attempts..."
            
            if curl -s --connect-timeout 10 "https://remote-control-command-server.onrender.com" > /dev/null; then
              echo "โ ุงูุฎุงุฏู ูุนูู ุจูุฌุงุญ!"
              break
            else
              echo "โณ ุงูุฎุงุฏู ูุง ูุฒุงู ูู ุทูุฑ ุงูุจุฏุก..."
              sleep 15
            fi
            
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุงูุชุฃูุฏ ูู ุญุงูุฉ ุงูุฎุงุฏู"
          fi