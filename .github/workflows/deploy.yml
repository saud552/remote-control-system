name: Deploy to Render

on:
  push:
    branches: [main, ready-for-merge-about-blank-fix]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Deploy Hook URL
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "๐ ูุญุต ุฅุนุฏุงุฏุงุช ุงููุดุฑ..."
          if [ -n "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "โ RENDER_DEPLOY_HOOK_URL ูุชููุฑ"
            echo "๐ URL: ${RENDER_DEPLOY_HOOK_URL:0:50}..."
          else
            echo "โ๏ธ RENDER_DEPLOY_HOOK_URL ุบูุฑ ูุชููุฑ"
            echo "๐ ูุฐุง ูุนูู ุฃู ุงููุดุฑ ุงูุชููุงุฆู ูุนุทู"
          fi
          
      - name: Deploy Command Server
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/ready-for-merge-about-blank-fix'
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "๐ ุจุฏุก ูุดุฑ ุงูุฎุงุฏู ุนูู Render..."
          echo "๐ ุงููุฑุน: ${{ github.ref }}"
          echo "๐ Commit: ${{ github.sha }}"
          
          if [ -n "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "๐ค ุฅุฑุณุงู ุทูุจ ุงููุดุฑ..."
            response=$(curl -s -w "%{http_code}" -o /tmp/deploy_response "$RENDER_DEPLOY_HOOK_URL")
            
            if [ "$response" = "200" ]; then
              echo "โ ุชู ุจุฏุก ุงููุดุฑ ุจูุฌุงุญ!"
              echo "๐ ุงุณุชุฌุงุจุฉ ุงูุฎุงุฏู:"
              cat /tmp/deploy_response
            else
              echo "โ ูุดู ูู ุจุฏุก ุงููุดุฑ - HTTP $response"
              echo "๐ ุงุณุชุฌุงุจุฉ ุงูุฎุงุฏู:"
              cat /tmp/deploy_response
              echo "โ๏ธ ุงููุดุฑ ูุดู ูููู ุณูููู ุงูุนูููุฉ"
            fi
          else
            echo "โ๏ธ RENDER_DEPLOY_HOOK_URL ุบูุฑ ููุนุฑููู ูู ุงูุฃุณุฑุงุฑ"
            echo "๐ ูุฅุถุงูุฉ ุฑุงุจุท ุงููุดุฑ:"
            echo "   1. ุงุฐูุจ ุฅูู GitHub Repository Settings"
            echo "   2. ุงุฎุชุฑ Secrets and variables > Actions"
            echo "   3. ุฃุถู Secret ุฌุฏูุฏ ุจุงูุงุณู: RENDER_DEPLOY_HOOK_URL"
            echo "   4. ุงุญุตู ุนูู Deploy Hook URL ูู Render Dashboard"
            echo ""
            echo "๐ ุณูุชู ุชุฎุทู ุงููุดุฑ ุงูุชููุงุฆู ูุฐู ุงููุฑุฉ"
            echo "๐ก ูููู ุงููุดุฑ ูุฏููุงู ูู Render Dashboard"
          fi
          
      - name: Wait for deployment
        run: |
          echo "โณ ุงูุชุธุงุฑ ุงูุชูุงู ุงููุดุฑ..."
          sleep 30
          echo "โ ุชู ุงูุงูุชูุงุก ูู ุนูููุฉ ุงููุดุฑ"
          
      - name: Verify deployment
        run: |
          echo "๐ ุงูุชุญูู ูู ุญุงูุฉ ุงูุฎุงุฏู..."
          
          # ูุญุงููุฉ ุงูุงุชุตุงู ุจุงูุฎุงุฏู
          max_attempts=5
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "๐ ูุญุงููุฉ $attempt ูู $max_attempts..."
            
            if curl -s --connect-timeout 10 "https://remote-control-command-server.onrender.com" > /dev/null; then
              echo "โ ุงูุฎุงุฏู ูุนูู ุจูุฌุงุญ!"
              break
            else
              echo "โณ ุงูุฎุงุฏู ูุง ูุฒุงู ูู ุทูุฑ ุงูุจุฏุก..."
              sleep 15
            fi
            
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุงูุชุฃูุฏ ูู ุญุงูุฉ ุงูุฎุงุฏู"
            echo "๐ก ูููู ุงูุชุญูู ูุฏููุงู ูู: https://remote-control-command-server.onrender.com"
          fi
          
      - name: Setup Instructions
        if: env.RENDER_DEPLOY_HOOK_URL == ''
        run: |
          echo ""
          echo "๐ ุชุนูููุงุช ุฅุนุฏุงุฏ ุงููุดุฑ ุงูุชููุงุฆู:"
          echo "=================================="
          echo ""
          echo "1๏ธโฃ ุงุญุตู ุนูู Deploy Hook URL:"
          echo "   โข ุงุฐูุจ ุฅูู: https://dashboard.render.com"
          echo "   โข ุงุฎุชุฑ ุฎุฏูุฉ: remote-control-command-server"
          echo "   โข ุงุฐูุจ ุฅูู: Settings"
          echo "   โข ุงูุณุฎ: Deploy Hook URL"
          echo ""
          echo "2๏ธโฃ ุฃุถู ุงูุณุฑ ูู GitHub:"
          echo "   โข ุงุฐูุจ ุฅูู: Repository Settings"
          echo "   โข ุงุฎุชุฑ: Secrets and variables > Actions"
          echo "   โข ุงุถุบุท: New repository secret"
          echo "   โข ุงูุงุณู: RENDER_DEPLOY_HOOK_URL"
          echo "   โข ุงููููุฉ: [Deploy Hook URL ุงูููุณูุฎ]"
          echo ""
          echo "3๏ธโฃ ุงุฎุชุจุฑ ุงููุดุฑ:"
          echo "   โข ุงุฏูุน commit ุฌุฏูุฏ"
          echo "   โข ุฑุงูุจ GitHub Actions"
          echo "   โข ุชุฃูุฏ ูู ูุฌุงุญ ุงููุดุฑ"
          echo ""
          echo "โ ุจุนุฏ ุงูุฅุนุฏุงุฏ ุณูุชู ุงููุดุฑ ุงูุชููุงุฆู ุนูุฏ ูู commit!"