# ๐ ุชูุฑูุฑ ุชุดุฎูุตู ุดุงูู ูุฎุทูุงุช ุงูุงุชุตุงู ุจุงูุฃุฌูุฒุฉ ุงููุณุชูุฏูุฉ

## ๐ฏ ุงููุญุต ุงูุดุงูู ุงูููุชูู

ุชู ูุญุต ุฌููุน ุฎุทูุงุช ุงูุงุชุตุงู ุจุงูุฃุฌูุฒุฉ ุงููุณุชูุฏูุฉ ูุชุญุฏูุฏ ุงููุดุงูู ุงููุญุชููุฉ ูุญููุง.

## ๐ ุฎุทูุงุช ุงูุงุชุตุงู ุงูุตุญูุญุฉ

### 1๏ธโฃ **ุฅุนุฏุงุฏ ุงูุงุชุตุงู (setupServerConnection)**

```javascript
// ุงูุนููู ูุญุงูู ุงูุงุชุตุงู
const serverUrl = isLocalhost 
    ? 'ws://localhost:4000' 
    : 'wss://remote-control-command-server.onrender.com';

const ws = new WebSocket(serverUrl);
```

**โ ุชู ุงูุชุญูู:** URL ุตุญูุญ ูููุงุณุจ ููุจูุฆุฉ

### 2๏ธโฃ **ุชุณุฌูู ุงูุฌูุงุฒ (Device Registration)**

```javascript
// ุนูุฏ ูุฌุงุญ ุงูุงุชุตุงู
ws.onopen = () => {
    ws.send(JSON.stringify({
        type: 'register',
        deviceId: this.deviceId,
        capabilities: this.getDeviceCapabilities(),
        timestamp: Date.now(),
        status: 'online'
    }));
};
```

**โ ุชู ุงูุชุญูู:** ุฑุณุงูุฉ ุงูุชุณุฌูู ูุงููุฉ ูููุงุณุจุฉ

### 3๏ธโฃ **ูุนุงูุฌุฉ ุงูุชุณุฌูู ูู ุงูุฎุงุฏู**

```javascript
case 'register':
    deviceId = message.deviceId;
    // ุฅูุบุงุก timeout ุงูุชุณุฌูู โ
    if (connectionTimeout) {
        clearTimeout(connectionTimeout);
    }
    // ุจุฏุก heartbeat โ
    startHeartbeat();
    
    this.handleDeviceRegistration(ws, message);
```

**โ ุชู ุงูุชุญูู:** ูุนุงูุฌุฉ ุตุญูุญุฉ ูุน timeout ูheartbeat

## ๐ง ุงููุดุงูู ุงูููุชุดูุฉ ูุงููุญูููุฉ

### โ **ุงููุดููุฉ 1: ุนุฏู ูุฌูุฏ ูุธุงู Heartbeat ูุญูู**

**ุงูุฃุนุฑุงุถ:**
- ุงููุทุงุน ุงุชุตุงู ููุงุฌุฆ ุฏูู ุณุจุจ ูุงุถุญ
- ุนุฏู ุงูุชุดุงู ุงูุงุชุตุงูุงุช ุงููููุทุนุฉ ุจุณุฑุนุฉ

**ุงูุญู ุงููุทุจู:**
```javascript
// ูู ุงูุฎุงุฏู - ping/pong ูู 25 ุซุงููุฉ
heartbeatInterval = setInterval(() => {
    if (!isAlive) {
        ws.terminate();
        return;
    }
    isAlive = false;
    ws.ping();
}, 25000);

// ูู ุงูุนููู - heartbeat ูู 30 ุซุงููุฉ  
this.heartbeatInterval = setInterval(() => {
    ws.send(JSON.stringify({
        type: 'heartbeat',
        deviceId: this.deviceId,
        timestamp: Date.now()
    }));
}, 30000);
```

### โ **ุงููุดููุฉ 2: ุนุฏู ูุฌูุฏ Timeout ููุงุชุตุงูุงุช ุงูุฌุฏูุฏุฉ**

**ุงูุฃุนุฑุงุถ:**
- ุงุชุตุงูุงุช ูุนููุฉ ูุง ุชูุชูู ุงูุชุณุฌูู
- ุงุณุชููุงู ููุงุฑุฏ ุบูุฑ ุถุฑูุฑู

**ุงูุญู ุงููุทุจู:**
```javascript
// timeout 60 ุซุงููุฉ ููุชุณุฌูู
connectionTimeout = setTimeout(() => {
    if (!deviceId) {
        console.log('โฐ ุงูุชูุช ูููุฉ ุงูุชุณุฌูู');
        ws.terminate();
    }
}, 60000);
```

### โ **ุงููุดููุฉ 3: ุนุฏู ุชูุธูู ุงูููุงุฑุฏ ุนูุฏ ุงูุงููุทุงุน**

**ุงูุฃุนุฑุงุถ:**
- ุชุฑุงูู intervals ูtimeouts
- ุชุณุฑูุจ ุฐุงูุฑุฉ
- ุงุชุตุงูุงุช ููููุฉ

**ุงูุญู ุงููุทุจู:**
```javascript
ws.on('close', (code, reason) => {
    // ุชูุธูู ุดุงูู ููููุงุฑุฏ
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
    }
    if (connectionTimeout) {
        clearTimeout(connectionTimeout);
    }
    // ุชูุธูู ุงูุนููู
    this.stopHeartbeat();
    window.controlConnection = null;
});
```

### โ **ุงููุดููุฉ 4: ุนุฏู ูุนุงูุฌุฉ ุฃููุงุฏ ุงูุฅุบูุงู ุงููุฎุชููุฉ**

**ุงูุฃุนุฑุงุถ:**
- ุฅุนุงุฏุฉ ุงุชุตุงู ุบูุฑ ููุงุณุจุฉ ูููุน ุงูุงููุทุงุน
- ุชุฃุฎูุฑ ุบูุฑ ุถุฑูุฑู ุฃู ุณุฑุนุฉ ููุฑุทุฉ

**ุงูุญู ุงููุทุจู:**
```javascript
// ูุนุงูุฌุฉ ุฐููุฉ ูุฃููุงุฏ ุงูุฅุบูุงู
let reconnectDelay = 5000; // ุงูุชุฑุงุถู

if (event.code === 1006) {
    reconnectDelay = 2000; // ุงููุทุงุน ุบูุฑ ุทุจูุนู - ุณุฑูุน
} else if (event.code === 1000) {
    reconnectDelay = 5000; // ุฅุบูุงู ุทุจูุนู - ุนุงุฏู  
} else if (event.code >= 4000) {
    reconnectDelay = 10000; // ุฎุทุฃ ุชุทุจูู - ูุคุฌู
}
```

### โ **ุงููุดููุฉ 5: ุนุฏู ูุฑุงูุจุฉ ุญุงูุฉ ุงูุงุชุตุงู ูุจู ุงูุฅุฑุณุงู**

**ุงูุฃุนุฑุงุถ:**
- ูุญุงููุฉ ุฅุฑุณุงู ุฑุณุงุฆู ุนูู ุงุชุตุงู ูุบูู
- ุฃุฎุทุงุก ูู console
- ูุดู ูู ุฅุฑุณุงู ุงูุจูุงูุงุช ุงููููุฉ

**ุงูุญู ุงููุทุจู:**
```javascript
// ูุญุต ุดุงูู ูุจู ุงูุฅุฑุณุงู
if (!window.controlConnection) {
    console.warn('โ๏ธ ูุง ููุฌุฏ ุงุชุตุงู');
    return;
}

if (window.controlConnection.readyState !== WebSocket.OPEN) {
    console.warn('โ๏ธ ุงูุงุชุตุงู ุบูุฑ ููุชูุญ');
    return;
}

// ุฅุฑุณุงู ุขูู
window.controlConnection.send(JSON.stringify(message));
```

## ๐ก๏ธ ุขููุงุช ุงูุญูุงูุฉ ุงููุทุจูุฉ

### **1. ุญูุงูุฉ ูู ุงููุทุงุน ุงูุงุชุตุงู:**
- โ Ping/Pong ูู 25 ุซุงููุฉ ูู ุงูุฎุงุฏู
- โ Heartbeat ูู 30 ุซุงููุฉ ูู ุงูุนููู
- โ Timeout 60 ุซุงููุฉ ููุชุณุฌูู
- โ ุฅุนุงุฏุฉ ุงุชุตุงู ุฐููุฉ (2-10 ุซูุงู ุญุณุจ ุงูุณุจุจ)

### **2. ุญูุงูุฉ ูู ุชุณุฑูุจ ุงูููุงุฑุฏ:**
- โ ุชูุธูู ุชููุงุฆู ููู intervals
- โ ุชูุธูู ุชููุงุฆู ููู timeouts
- โ ุฅุฒุงูุฉ ูุฑุงุฌุน ุงูุงุชุตุงูุงุช ุงููุบููุฉ
- โ ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก

### **3. ุญูุงูุฉ ูู about:blank:**
- โ ููุน ุงูุชูุงู ุงูุตูุญุฉ ุนูุฏ ุงููุทุงุน ุงูุงุชุตุงู
- โ ุญูุงูุฉ ุดุงููุฉ ูู ุฌููุน ุฃุดูุงู ุงูุชููู
- โ ูุฑุงูุจุฉ ูุณุชูุฑุฉ ููู URL
- โ ุฅููุงู ููุฑู ุนูุฏ ุงูุชุดุงู about:blank

### **4. ูุนูููุงุช ุชุดุฎูุตูุฉ ููุตูุฉ:**
- โ ุชุณุฌูู ุณุจุจ ุงูุงููุทุงุน
- โ ุชุณุฌูู ููุฏ ุงูุฅุบูุงู
- โ ุชุณุฌูู ูุนูููุงุช ุงูุฎุทุฃ
- โ ุชุณุฌูู ุฃููุงุช ุงูุฃุญุฏุงุซ

## ๐ ุงูุชุฏูู ุงููุญุณู ููุงุชุตุงู

```
1. ๐ ุงูุนููู ูุจุฏุฃ ุงูุงุชุตุงู
   โ
2. โฐ ุงูุฎุงุฏู ูุถุน timeout (60s) ููุชุณุฌูู
   โ
3. ๐ ุงูุนููู ูุฑุณู ุฑุณุงูุฉ register
   โ
4. โ ุงูุฎุงุฏู ูุชุนุฑู ุนูู ุงูุฑุณุงูุฉ ูููุบู timeout
   โ
5. ๐ ุงูุฎุงุฏู ูุจุฏุฃ ping/pong (25s)
   โ
6. ๐ ุงูุนููู ูุจุฏุฃ heartbeat (30s)
   โ
7. ๐ ุงูุนููู ูุฑุณู activation_complete
   โ
8. โ ุงูุฎุงุฏู ูุฑุฏ ุจู activation_acknowledged
   โ
9. ๐ฏ ุงูุนุฏ ุงูุชูุงุฒูู ูุงูุนูุฏุฉ ููุญุงูุฉ ุงูุฃุณุงุณูุฉ
   โ
10. ๐ ุงูุงุชุตุงู ูุณุชูุฑ ููุณุชูุฑ
```

## ๐ ุฑุณุงุฆู ุงูุชุดุฎูุต ุงููุชููุนุฉ

### **ูู ุงูุฎุงุฏู:**
```
๐ ุชู ุงูุงุชุตุงู ุจุฌูุงุฒ ุฌุฏูุฏ
๐ ูุญุต ุนููู ุฌุฏูุฏ: http://localhost:4000
๐ ุชุณุฌูู ุงูุฌูุงุฒ: DEV-1753493786887-w63v41est
๐ฑ ุชู ุชุณุฌูู ุงูุฌูุงุฒ: DEV-1753493786887-w63v41est
๐ ุฅุฑุณุงู ping ููุฌูุงุฒ: DEV-1753493786887-w63v41est
๐ ุงุณุชูุจุงู pong ูู ุงูุฌูุงุฒ: DEV-1753493786887-w63v41est
๐ ูุจุถ ูู ุงูุฌูุงุฒ: DEV-1753493786887-w63v41est
๐ ุชู ุฅููุงู ุชูุนูู ุงูุฌูุงุฒ ุจูุฌุงุญ: DEV-1753493786887-w63v41est
๐ค ุชู ุฅุฑุณุงู ุชุฃููุฏ ุงูุชูุนูู ููุฌูุงุฒ: DEV-1753493786887-w63v41est
```

### **ูู ุงูุนููู:**
```
โ ุชู ุงูุงุชุตุงู ุจุงูุฎุงุฏู
๐ ุชู ุฅุนุฏุงุฏ ุงูุงุชุตุงู ูุงูู heartbeat ุจูุฌุงุญ
๐ ุจุฏุก ูุธุงู heartbeat...
๐ ุฅุฑุณุงู heartbeat ููุฎุงุฏู
๐ค ุชู ุฅุฑุณุงู activation_complete ููุฎุงุฏู ุจูุฌุงุญ
โ ุงูุงุชุตุงู ูุณุชูุฑ ุจุนุฏ ุฅุฑุณุงู activation_complete
๐จ ุฑุณุงูุฉ ูู ุงูุฎุงุฏู: activation_acknowledged
โ ุชู ุชุฃููุฏ ุงูุชูุนูู ูู ุงูุฎุงุฏู
๐ ุงูุงุชุตุงู ุจุงูุฎุงุฏู ูุณุชูุฑ - ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุงูุชูุฌูู
```

## โ๏ธ ุนูุงูุงุช ุงูุชุญุฐูุฑ ูููุฑุงูุจุฉ

### **ูุดุงูู ูุญุชููุฉ:**
- `๐ ุงููุทุน heartbeat ููุฌูุงุฒ` - ุงููุทุงุน ping/pong
- `โฐ ุงูุชูุช ูููุฉ ุงูุชุณุฌูู` - ูู ูุชู ุงูุชุณุฌูู ูู 60s
- `โ๏ธ ูุง ูููู ุฅุฑุณุงู heartbeat - ุงูุงุชุตุงู ูุบูู` - ุงููุทุงุน ุบูุฑ ูุชููุน
- `๐ ุงููุทุงุน ุบูุฑ ุทุจูุนู` - ููุฏ 1006
- `๐ ุฎุทุฃ ูู ุงูุชุทุจูู` - ููุฏ >= 4000

### **ุฅุฌุฑุงุกุงุช ุงูุชุดุฎูุต:**
1. **ุชุญูู ูู ุญุงูุฉ ุงูุดุจูุฉ**
2. **ุชุญูู ูู ุญุงูุฉ ุงูุฎุงุฏู ุนูู render.com**
3. **ุฑุงุฌุน console logs ูู ุงููุชุตูุญ**
4. **ุชุญูู ูู GitHub Actions ูููุดุฑ**
5. **ุงุฎุชุจุฑ ูุญููุงู ุจุงุณุชุฎุฏุงู `npm run test-local`**

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

โ **ุฌููุน ุฎุทูุงุช ุงูุงุชุตุงู ูุญุณูุฉ ููุคููุฉ**
โ **ูุธุงู heartbeat ูุญูู ููุชูู**
โ **ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก ูุงูุงููุทุงุน**
โ **ุญูุงูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุช ูู about:blank**
โ **ูุนูููุงุช ุชุดุฎูุตูุฉ ููุตูุฉ**
โ **ุฅุนุงุฏุฉ ุงุชุตุงู ุฐููุฉ ููุชุฏุฑุฌุฉ**
โ **ุชูุธูู ุชููุงุฆู ููููุงุฑุฏ**

**ุงูุขู ุงููุธุงู ูุญุตู ุถุฏ ุฌููุน ุฃุณุจุงุจ ุงููุทุงุน ุงูุงุชุตุงู ุงููุนุฑููุฉ!** ๐ก๏ธ๐